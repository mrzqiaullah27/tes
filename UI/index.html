<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Diagnosis Katarak — Forward Chaining + Certainty Factor</title>
<style>
  :root{ --bg:#f7f8fa; --card:#ffffff; --muted:#6b7280; --text:#111827; --primary:#2f6feb; --primary-dark:#1f4fb5; --border:#e5e7eb; }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 "Segoe UI",system-ui,-apple-system,Roboto,Arial}
  .container{max-width:1220px;margin:0 auto;padding:16px}
  .header{padding:18px 16px}
  .title{font-weight:600;font-size:22px;margin:0}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
  .section{padding:16px}
  .muted{color:var(--muted)}
  .instructions pre{background:#fafafa;border:1px dashed var(--border);padding:12px;border-radius:10px;white-space:pre-wrap;margin:0}
  .list{overflow:visible}
  .row{display:grid;grid-template-columns:64px 1fr minmax(280px, 320px);gap:12px;align-items:flex-start;padding:10px 12px;border-top:1px solid var(--border)}
  .row.head{font-weight:600;background:#fbfbfc;position:sticky;top:0;z-index:5}
  .row:nth-child(even){background:#fcfcfe}
  .qtext{word-wrap:break-word}
  .radios{display:flex;gap:8px;align-items:center;justify-content:flex-start;flex-wrap:wrap}
  .radios label{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--border);border-radius:8px;cursor:pointer;user-select:none;background:#fff;font-size:14px}
  .radios input{appearance:none;width:16px;height:16px;border:2px solid var(--border);border-radius:50%;display:inline-block;position:relative}
  .radios input:checked{border-color:var(--primary)}
  .radios input:checked::after{content:"";position:absolute;inset:3px;background:var(--primary);border-radius:50%}
  .footer{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px 0}
  .btns{display:flex;gap:10px;align-items:center}
  .btn{border:1px solid var(--border);background:#fff;color:#111827;padding:10px 14px;border-radius:10px;cursor:pointer;transition:.15s;font-weight:600}
  .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  .btn.primary:hover{background:var(--primary-dark)}
  .result{padding:12px;border:1px solid var(--border);border-radius:10px;background:#fff;min-height:56px}
  .result h4{margin:0 0 6px 0;font-size:14px}
  .result p{margin:0;font-size:14px}
</style>
</head>
<body>
<div class="container">
  <header class="header"><h1 class="title">Diagnosis Katarak</h1></header>

  <section class="card section instructions">
    <h3 style="margin:0 0 8px 0">Petunjuk</h3>
    <pre id="instr-text">Memuat skala keyakinan…</pre>
  </section>

  <section class="card section list" style="margin-top:14px">
    <div class="row head"><div>No.</div><div>Pertanyaan Gejala</div><div>Jawaban (1–5)</div></div>
    <div id="question-rows"></div>
  </section>

  <div class="footer">
    <div class="result card">
      <h4>Hasil Diagnosa</h4>
      <p id="result-text" class="muted">—</p>
    </div>
    <div class="btns">
      <button class="btn" id="reset-btn">Reset</button>
      <button class="btn primary" id="diagnose-btn">Diagnosa</button>
    </div>
  </div>
</div>

<!-- panggil fungsi dari engine.js -->
<script type="module">
  import {
    LABELS_JSON, RULES_JSON,
    loadJSON, diagnose, orderedCodes, indexToCFMap
  } from "./engine.js";

  const instrEl  = document.getElementById("instr-text");
  const rowsEl   = document.getElementById("question-rows");
  const resultEl = document.getElementById("result-text");
  const btnDiag  = document.getElementById("diagnose-btn");
  const btnReset = document.getElementById("reset-btn");

  let LABELS=null, RULES=null, CODES=[], DISEASES=null, INDEX_TO_VALUE=[];

  function renderInstructions(certaintyTerms){
    const { order, values } = indexToCFMap(certaintyTerms);
    INDEX_TO_VALUE = values;
    instrEl.textContent = `Silakan jawab setiap pertanyaan berikut sesuai kondisi Anda.
Skala keyakinan:
  1. ${order[0]} (${values[0]})
  2. ${order[1]} (${values[1]})
  3. ${order[2]} (${values[2]})
  4. ${order[3]} (${values[3]})
  5. ${order[4]} (${values[4]})`;
  }

  function renderQuestions(symptoms){
    rowsEl.innerHTML = "";
    CODES = orderedCodes(symptoms);
    CODES.forEach((code, idx)=>{
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div>${String(idx+1).padStart(2,"0")}</div>
        <div class="qtext">${symptoms[code]}</div>
        <div class="radios" role="radiogroup" aria-label="Skala untuk ${symptoms[code]}">
          ${[1,2,3,4,5].map(i => `
            <label>
              <input type="radio" name="${code}" value="${i}" ${i===1?'checked':''}/>
              <span>${i}</span>
            </label>
          `).join("")}
        </div>`;
      rowsEl.appendChild(row);
    });
  }

  function collectUserCF(){
    const m={};
    CODES.forEach(code=>{
      const el = document.querySelector(`input[name="${code}"]:checked`);
      m[code] = INDEX_TO_VALUE[parseInt(el.value,10)-1];
    });
    return m;
  }

  btnDiag.addEventListener("click", ()=>{
    if(!LABELS || !RULES) return;
    const out = diagnose(RULES, collectUserCF());
    if(!out.length){
      resultEl.textContent = "Tidak ada penyakit yang terdeteksi berdasarkan jawaban Anda.";
      resultEl.classList.add("muted");
      return;
    }
    const [topDis, topCF] = out[0];
    const name = DISEASES[topDis] ?? topDis;
    resultEl.textContent = `${name} dengan Nilai CF: ${topCF.toFixed(2)}`;
    resultEl.classList.remove("muted");
  });

  btnReset.addEventListener("click", ()=>{
    if(!CODES.length) return;
    CODES.forEach(code=>{
      const first = document.querySelector(`input[name="${code}"][value="1"]`);
      if(first) first.checked = true;
    });
    resultEl.textContent = "—";
    resultEl.classList.add("muted");
  });

  // INIT
  (async function init(){
    try{
      const [rules, labels] = await Promise.all([loadJSON(RULES_JSON), loadJSON(LABELS_JSON)]);
      RULES = rules; LABELS = labels;
      const symptoms = labels.symptoms;
      DISEASES = labels.diseases;
      const ct = labels.certainty_terms || labels.certaintyTerms || labels["certainty_terms"];
      renderInstructions(ct);
      renderQuestions(symptoms);
    }catch(err){
      console.error(err);
      resultEl.textContent = "Gagal memuat file JSON. Jalankan via server lokal (Live Server/localhost) dan pastikan kedua file ada di folder yang sama.";
      resultEl.classList.remove("muted");
    }
  })();
</script>
</body>
</html>